<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Website Infrastructure Tracker</title>
<link rel="stylesheet" href="styles.css">
<style>
  .container { max-width: 1000px; margin: 0 auto; padding: 32px; }
  table { width: 100%; border-collapse: collapse; margin-top: 16px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background: #f5f5f5; }
  .toolbar { display: flex; gap: 12px; margin-top: 12px; }
  .msg { margin-top: 12px; }
  .ok { color: green; }
  .err { color: red; }
  .btn { cursor: pointer; padding: 6px 12px; background:#333; color:#fff; border:none; border-radius:4px; }
</style>
</head>
<body>
  <header class="topbar">
    <div class="container row">
      <div class="brand">
        <strong>Website Infrastructure Tracker</strong>
      </div>
    </div>
  </header>

  <section class="section">
    <div class="container">
      <h1>Track Website Infrastructure</h1>
      <p>Add, view, and manage your infrastructure records.</p>

      <div>
        <input type="text" id="websiteInput" placeholder="Website (e.g., www.iamvirelia.org)">
        <input type="text" id="hostedInput" placeholder="Hosted on (e.g., Netlify)">
        <input type="text" id="codeInput" placeholder="Source code (e.g., GitHub)">
        <input type="text" id="websiteEmailInput" placeholder="Website service email (e.g., ReSend)">
        <input type="text" id="corporateEmailInput" placeholder="Corporate email (e.g., Zoho)">
        <input type="text" id="aiDilemmaInput" placeholder="AI Dilemma Service (e.g., Chat GPT)">
        <button id="addBtn" class="btn">Add Record</button>
        <button id="refreshBtn" class="btn">Refresh Table</button>
      </div>

      <p id="status" class="msg"></p>

      <table>
        <thead>
          <tr>
            <th>Website</th>
            <th>Hosted On</th>
            <th>Code Repository</th>
            <th>Website Service Email</th>
            <th>Corporate Email</th>
            <th>AI Dilemma Service</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <tr><td colspan="7">Loading…</td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <script>
    const websiteInput = document.getElementById('websiteInput');
    const hostedInput = document.getElementById('hostedInput');
    const codeInput = document.getElementById('codeInput');
    const websiteEmailInput = document.getElementById('websiteEmailInput');
    const corporateEmailInput = document.getElementById('corporateEmailInput');
    const aiDilemmaInput = document.getElementById('aiDilemmaInput');
    const addBtn = document.getElementById('addBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const statusEl = document.getElementById('status');
    const tableBody = document.getElementById('tableBody');

    let existingRecords = [];

    function setMsg(text, ok=false){
      statusEl.textContent = text;
      statusEl.className = 'msg ' + (ok ? 'ok' : 'err');
    }

    async function loadRecords() {
      tableBody.innerHTML = '<tr><td colspan="7">Loading…</td></tr>';
      try {
        const res = await fetch('/.netlify/functions/list-tracking');
        const data = await res.json();
        existingRecords = data.records || [];
        tableBody.innerHTML = '';
        if (!existingRecords.length) {
          tableBody.innerHTML = '<tr><td colspan="7"><em>No records found.</em></td></tr>';
          return;
        }
        existingRecords.forEach((r) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${r.website}</td>
            <td>${r.hostedOn}</td>
            <td>${r.codeStoredOn}</td>
            <td>${r.websiteEmail}</td>
            <td>${r.corporateEmail}</td>
            <td>${r.aiDilemmaService}</td>
            <td><button class="btn deleteBtn" data-id="${r.website}">Delete</button></td>
          `;
          tableBody.appendChild(tr);
        });

        document.querySelectorAll('.deleteBtn').forEach(btn => {
          btn.addEventListener('click', async () => {
            if (!confirm(`Delete record for "${btn.dataset.id}"?`)) return;
            try {
              const res = await fetch('/.netlify/functions/delete-tracking', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ website: btn.dataset.id })
              });
              const data = await res.json();
              if (!data.ok) throw new Error(data.error || 'Delete failed');
              setMsg('Deleted record!', true);
              await loadRecords();
            } catch (err) {
              setMsg(err.message || 'Delete failed');
            }
          });
        });
      } catch (err) {
        tableBody.innerHTML = '<tr><td colspan="7">Failed to load records.</td></tr>';
        setMsg(err.message || 'Error loading records');
      }
    }

    addBtn.addEventListener('click', async () => {
      const record = {
        website: websiteInput.value.trim(),
        hostedOn: hostedInput.value.trim(),
        codeStoredOn: codeInput.value.trim(),
        websiteEmail: websiteEmailInput.value.trim(),
        corporateEmail: corporateEmailInput.value.trim(),
        aiDilemmaService: aiDilemmaInput.value.trim()
      };

      // INLINE VALIDATION
      if (!record.website) return setMsg('Website is required');
      if (!record.hostedOn) return setMsg('Hosted On is required');
      if (!record.codeStoredOn) return setMsg('Code Repository is required');
      if (!record.websiteEmail) return setMsg('Website Email Service is required');
      if (!record.corporateEmail) return setMsg('Corporate Email is required');
      if (!record.aiDilemmaService) return setMsg('AI Dilemma Service is required');

      if (existingRecords.some(r => r.website.toLowerCase() === record.website.toLowerCase())) {
        return setMsg('Website already exists in records');
      }

      try {
        const res = await fetch('/.netlify/functions/add-tracking', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(record)
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || 'Add failed');
        setMsg('Record added!', true);
        websiteInput.value = hostedInput.value = codeInput.value = websiteEmailInput.value = corporateEmailInput.value = aiDilemmaInput.value = '';
        await loadRecords();
      } catch (err) {
        setMsg(err.message || 'Error adding record');
      }
    });

    refreshBtn.addEventListener('click', loadRecords);
    window.addEventListener('DOMContentLoaded', loadRecords);
  </script>
</body>
</html>
