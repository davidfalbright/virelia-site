<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Website & Email Tracker — V.I.R.E.L.I.A.</title>
<link rel="stylesheet" href="styles.css" />
<style>
  body { font-family: Arial, sans-serif; background:#0b0d10; color:#e5eef7; }
  .container { max-width: 1000px; margin: 2rem auto; padding: 1rem; }
  table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
  th, td { border: 1px solid #1f2633; padding: 8px; text-align: left; }
  th { background: #131823; }
  tr:nth-child(even) { background: #101318; }
  .btn { padding: 0.5rem 1rem; margin: 0.25rem; cursor: pointer; background:#6fb2ff; color:#0b0d10; border:none; border-radius:4px; }
  .btn:disabled { background:#444; cursor: not-allowed; }
  .msg { margin-top: 1rem; }
  .ok { color: #10b981; }
  .err { color: #ef4444; }
  .form-inline { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 1rem; }
  .form-inline input { padding: 0.25rem; flex: 1 1 150px; }
</style>
</head>
<body>
<div class="container">
  <h1>Website & Email Tracker</h1>
  <p>Track your websites (Squarespace, Netlify, GitHub) and login emails (Resend, etc.)</p>

  <div class="form-inline">
    <input id="websiteInput" placeholder="Website URL" />
    <input id="platformInput" placeholder="Platform" />
    <input id="emailInput" placeholder="Login Email" />
    <button id="addBtn" class="btn">Add Record</button>
  </div>

  <div>
    <button id="refreshBtn" class="btn">Refresh</button>
    <button id="saveBtn" class="btn">Save Table to Blob</button>
  </div>

  <table id="trackerTable">
    <thead>
      <tr>
        <th>Website</th>
        <th>Platform</th>
        <th>Login Email</th>
        <th>Email Sent?</th>
        <th>Email Clicked?</th>
        <th>Code Verified?</th>
        <th>Last Updated</th>
      </tr>
    </thead>
    <tbody id="tableBody">
      <tr><td colspan="7">Loading…</td></tr>
    </tbody>
  </table>

  <p id="status" class="msg"></p>
</div>

<script type="module">
import { getStore } from "@netlify/blobs";

const siteID = "<YOUR_NETLIFY_SITE_ID>";
const token  = "<YOUR_NETLIFY_BLOBS_TOKEN>";
const storeName = "tracker_data";

const store = getStore({ name: storeName, siteID, token });

const tableBody = document.getElementById("tableBody");
const statusEl = document.getElementById("status");
const refreshBtn = document.getElementById("refreshBtn");
const saveBtn = document.getElementById("saveBtn");
const addBtn = document.getElementById("addBtn");
const websiteInput = document.getElementById("websiteInput");
const platformInput = document.getElementById("platformInput");
const emailInput = document.getElementById("emailInput");

function setMsg(text, ok=false){
  statusEl.textContent = text || "";
  statusEl.className = 'msg ' + (ok ? 'ok' : 'err');
}

async function loadTable() {
  setMsg('');
  tableBody.innerHTML = '<tr><td colspan="7">Loading…</td></tr>';
  try {
    const raw = await store.get("tracker");
    const entries = raw ? JSON.parse(raw) : [];
    if (entries.length === 0) {
      tableBody.innerHTML = '<tr><td colspan="7"><em>No entries found.</em></td></tr>';
      return;
    }

    tableBody.innerHTML = '';
    for (const e of entries) {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${e.website || ''}</td>
        <td>${e.platform || ''}</td>
        <td>${e.loginEmail || ''}</td>
        <td>${e.emailSent ? 'Yes' : 'No'}</td>
        <td>${e.emailClicked ? 'Yes' : 'No'}</td>
        <td>${e.codeVerified ? 'Yes' : 'No'}</td>
        <td>${e.updatedAt ? new Date(e.updatedAt).toLocaleString() : 'N/A'}</td>
      `;
      tableBody.appendChild(row);
    }
  } catch(err){
    tableBody.innerHTML = '<tr><td colspan="7">Failed to load data</td></tr>';
    console.error(err);
    setMsg('Error loading table', false);
  }
}

async function saveTable() {
  try {
    const rows = Array.from(tableBody.querySelectorAll("tr"));
    const data = rows.map(r => {
      const cells = r.querySelectorAll("td");
      if (cells.length !== 7) return null;
      return {
        website: cells[0].textContent.trim(),
        platform: cells[1].textContent.trim(),
        loginEmail: cells[2].textContent.trim(),
        emailSent: cells[3].textContent.trim() === 'Yes',
        emailClicked: cells[4].textContent.trim() === 'Yes',
        codeVerified: cells[5].textContent.trim() === 'Yes',
        updatedAt: new Date().toISOString(),
      };
    }).filter(Boolean);

    await store.set("tracker", JSON.stringify(data));
    setMsg("Saved successfully!", true);
  } catch(err){
    console.error(err);
    setMsg("Failed to save table", false);
  }
}

addBtn.addEventListener('click', async () => {
  const website = websiteInput.value.trim();
  const platform = platformInput.value.trim();
  const email = emailInput.value.trim();
  if (!website || !platform || !email) {
    setMsg("All fields are required to add a record", false);
    return;
  }

  try {
    const raw = await store.get("tracker");
    const entries = raw ? JSON.parse(raw) : [];
    entries.push({
      website, platform, loginEmail: email,
      emailSent: false, emailClicked: false, codeVerified: false,
      updatedAt: new Date().toISOString(),
    });
    await store.set("tracker", JSON.stringify(entries));
    websiteInput.value = platformInput.value = emailInput.value = '';
    setMsg("Record added!", true);
    loadTable();
  } catch(err){
    console.error(err);
    setMsg("Failed to add record", false);
  }
});

refreshBtn.addEventListener('click', loadTable);
saveBtn.addEventListener('click', saveTable);

// Initial load
loadTable();
</script>
</body>
</html>
