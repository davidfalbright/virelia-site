<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>V.I.R.E.L.I.A. — Virtual Intelligence with Responsible Ethics, Logic, and Independent Alignment</title>
  <meta name="description" content="Virelia is a global AI ethics framework providing ethical decision support for real-world dilemmas.">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />

  <!-- CSS: hide sections whenever <body class="guest"> is present -->
  <style>
    body.guest #navContactLink,
    body.guest #footContactLink,
    body.guest #contact,
    body.guest #verdict,
    body.guest #manageEmailsLink {
      display: none !important;
    }

    body.guest .nav a:not(#logoutLink) {
      display: none !important;
    }

    body.guest .footer a:not(#logoutLink) {
      display: none !important;
    }
  </style>

  <!-- Auth guard + session bootstrap -->
  <script>
  (function () {
    function readCookie(name) {
      const m = document.cookie.match(new RegExp('(?:^|;\\s*)' + name.replace(/[-[\]/{}()*+?.\\^$|]/g, '\\$&') + '=([^;]*)'));
      return m ? decodeURIComponent(m[1]) : null;
    }
    function readToken() {
      try {
        const ls = localStorage.getItem('session_token');
        if (ls) return ls;
      } catch {}
      return readCookie('session_token');
    }
    function parsePayload(jwt) {
      const parts = (jwt || '').split('.');
      if (parts.length < 2) return null;
      const b64 = parts[1].replace(/-/g, '+').replace(/_/g, '/');
      try {
        const json = atob(b64);
        return JSON.parse(decodeURIComponent(
          json.split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')
        ));
      } catch {
        try { return JSON.parse(atob(b64)); } catch { return null; }
      }
    }
    function clearSessionEverywhere() {
      try { localStorage.removeItem('session_token'); } catch {}
      try { localStorage.removeItem('session_role'); } catch {}
      document.cookie = 'session_token=; Max-Age=0; Path=/; SameSite=Lax';
      document.cookie = 'session_token=; Max-Age=0; Path=/; SameSite=Lax; Domain=.iamvirelia.org';
      document.cookie = 'session_token=; Max-Age=0; Path=/; SameSite=Lax; Domain=www.iamvirelia.org';
      document.cookie = 'session_role=; Max-Age=0; Path=/; SameSite=Lax';
      document.cookie = 'session_role=; Max-Age=0; Path=/; SameSite=Lax; Domain=.iamvirelia.org';
      document.cookie = 'session_role=; Max-Age=0; Path=/; SameSite=Lax; Domain=www.iamvirelia.org';
    }
    function bounce(reason) {
      clearSessionEverywhere();
      location.replace('/?session=' + encodeURIComponent(reason || 'missing'));
    }

    // 1) Require a token (guest or regular)
    const token = readToken();
    if (!token) return bounce('missing');

    // 2) Parse and validate exp (in ms, as issued by your functions)
    const payload = parsePayload(token) || {};
    const exp = typeof payload.exp === 'number' ? payload.exp : 0;
    if (!exp || Date.now() > exp) return bounce('expired');

    // 3) Determine guest role robustly
    const jwtRole = payload.role || null;
    const jwtEmail = payload.email || payload.sub || '';
    let sessionRole = null;
    try { sessionRole = localStorage.getItem('session_role'); } catch {}
    if (!sessionRole) sessionRole = readCookie('session_role');

    const isGuest =
      jwtRole === 'guest' ||
      sessionRole === 'guest' ||
      jwtEmail === 'guest';

    // 4) Expose session + mark <body> with .guest for CSS hiding
    window.__SESSION__ = { token, email: jwtEmail, role: jwtRole || sessionRole || null };
    window.__clearSessionEverywhere__ = clearSessionEverywhere;

    // Add the class ASAP (before DOMContentLoaded) to minimize flicker
    if (isGuest) {
      document.addEventListener('DOMContentLoaded', () => { document.body.classList.add('guest'); });
    } else {
      document.addEventListener('DOMContentLoaded', () => { document.body.classList.remove('guest'); });
    }
  })();
  </script>
</head>
<body>

  <!-- Content goes here -->
  <header class="topbar">
    <div class="container row">
      <div class="brand">
        <div class="logo">
          <img src="https://raw.githubusercontent.com/davidfalbright/virelia-site/main/images/Bronze_Accord.png" alt="Virelia Logo">
        </div>
        <div class="brand-text">
          <strong>V.I.R.E.L.I.A.</strong>
          <span>Virtual Intelligence with Responsible Ethics, Logic, and Independent Alignment</span>
        </div>
      </div>

      <nav class="nav">
        <a href="about_us.html">About Us</a>
        <a href="#how">How it works</a>
        <a href="impact.html">Impact & Benefits</a>
        <a href="differentiation.html">Market Differentiation</a>
        <a href="implementation.html">Implementation</a>
        <a href="solutions.html">Delivery Models</a>
        <a href="#contact" id="navContactLink">Contact</a>
        <a href="/delete-email.html" id="manageEmailsLink">Manage emails</a>
        <a href="#" id="logoutLink" style="margin-left:.75rem;">Log out</a>
      </nav>
    </div>
  </header>

  <!-- Coming Soon banner -->
  <section class="banner">
    <div class="container row">
      <div class="banner-dot"></div>
      <div class="banner-text">
        <strong>Coming soon:</strong> Limited pilot access. We’re not accepting client work yet.
      </div>
    </div>
  </section>

  <!-- Your page content here (hero, etc.) -->

  <!-- Ask Virelia Section (only shown if not guest) -->
  <section id="verdict" class="container verdict-section">
    <h2 class="section-title">Ask Virelia:</h2>
    <p class="section-subtitle">Describe your dilemma in plain language. I’ll return a decision route and explain which beliefs were triggered.</p>

    <div class="verdict-card">
      <label for="dilemmaInput" class="verdict-label">Your dilemma</label>
      <textarea id="dilemmaInput" class="verdict-input" rows="6" placeholder="Virelia is temporarily offline — API not connected." disabled=true></textarea>
      
      <div class="verdict-actions">
        <button id="getVerdictBtn" class="btn btn-primary" disabled=true>Get Verdict</button>
        <span id="verdictStatus" class="verdict-status" aria-live="polite"></span>
      </div>

      <div id="verdictResult" class="verdict-result" hidden>
        <div class="verdict-row">
          <div class="verdict-pill" id="verdictRoute">Route: —</div>
          <div class="verdict-meta"><strong>Risk:</strong> <span id="verdictRisk">—</span> • <strong>Urgency:</strong> <span id="verdictUrgency">—</span></div>
        </div>
        <p id="verdictMessage" class="verdict-message"></p>

        <div id="verdictTriggersWrap" class="verdict-triggers" hidden>
          <h3 class="verdict-triggers-title">Triggered Items</h3>
          <ul id="verdictTriggers" class="verdict-trigger-list"></ul>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="footer">
    <div class="container row between">
      <div>© <span id="year"></span> Virelia. All rights reserved.</div>
      <div class="foot-links">
        <a href="about_us.html">About Us</a>
        <a href="#how">How it works</a>
        <a href="#contact" id="footContactLink">Contact</a>
        <a href="impact.html">Impact & Benefits</a>
      </div>
    </div>
  </footer>

  <!-- Utilities: year + logout -->
  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    document.getElementById('logoutLink')?.addEventListener('click', function(e){
      e.preventDefault();
      (window.__clearSessionEverywhere__ || function(){})();
      location.replace('/');
    });
  </script>

  <script src="script_landingPage.js" defer></script>
</body>
</html>
